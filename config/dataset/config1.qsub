#!/bin/bash
#COBALT -t 120
#COBALT -n 4
#COBALT -A datascience
#COBALT --attrs pubnet=true

#
# source /lus/theta-fs0/software/thetagpu/conda/tf_master/2021-01-08/mconda3/setup.sh
# source /lus/theta-fs0/projects/datascience/cadams/ThetaGPU/venvs/conda_tf/2021-01-08/bin/activate

CONTAINER=/lus/theta-fs0/software/thetagpu/nvidia-containers/tensorflow2/tf2_21.02-py3.simg


export TF_XLA_FLAGS=--tf_xla_auto_jit=2

N_NODES=$(cat $COBALT_NODEFILE | wc -l)
RANKS_PER_NODE=8
let N_RANKS=${RANKS_PER_NODE}*${N_NODES}


mpirun -n $N_RANKS -hostfile ${COBALT_NODEFILE} -map-by node \
singularity exec --nv -B /lus $CONTAINER << EOF
    source /lus/theta-fs0/projects/datascience/cadams/ThetaGPU/venvs/tensorflow2/tf2_21.02/bin/activate

    export TF_XLA_FLAGS=--tf_xla_auto_jit=2

    python \
    /home/cadams/ThetaGPU/CosmicTagger/bin/exec.py \
    --config-name config1 \
    mode=train \
    run.id=job_test_1_ds1 \
    data.downsample=1 \
EOF
